name: CI

on:
  push:
  pull_request:

# Prevent overlapping runs on the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      lint-result: ${{ steps.lint.outcome }}
      typecheck-result: ${{ steps.typecheck.outcome }}
      test-result: ${{ steps.test.outcome }}
      build-result: ${{ steps.build.outcome }}
      lint-duration: ${{ steps.lint.outputs.duration }}
      typecheck-duration: ${{ steps.typecheck.outputs.duration }}
      test-duration: ${{ steps.test.outputs.duration }}
      build-duration: ${{ steps.build.outputs.duration }}

    env:
      NODE_ENV: production
      FORCE_COLOR: 1

    steps:
      # ---------------------------------------------------------
      # 0. Pre‚Äëfirewall environment hygiene
      # ---------------------------------------------------------
      - name: üõ°Ô∏è Pre-firewall environment setup
        run: |
          npm config set audit false
          npm config set fund false
          npm config set update-notifier false

      # ---------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # 2. Node setup
      # ---------------------------------------------------------
      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ---------------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------------
      - name: üì¶ Install dependencies
        run: npm ci

      # ---------------------------------------------------------
      # 3.5. Create logs directory
      # ---------------------------------------------------------
      - name: üìÅ Create logs directory
        run: mkdir -p logs

      # ---------------------------------------------------------
      # 4. Repo Health (optional hook)
      # ---------------------------------------------------------
      - name: ü©∫ Repo Health Scan
        run: |
          if [ -f ./tools/repo-health/scan.sh ]; then
            chmod +x ./tools/repo-health/scan.sh
            ./tools/repo-health/scan.sh
          else
            echo "No repo-health tool found. Skipping."
          fi

      # ---------------------------------------------------------
      # 5. Bootstrap (environment validation + build prep)
      # ---------------------------------------------------------
      - name: üöÄ Run Bootstrap
        run: |
          chmod +x tools/bootstrap/bootstrap.sh
          ./tools/bootstrap/bootstrap.sh

      # ---------------------------------------------------------
      # 6. Audit (contract + workflow validation)
      # ---------------------------------------------------------
      - name: üîç Run Audit
        run: |
          chmod +x tools/audit/audit.sh
          ./tools/audit/audit.sh

      # ---------------------------------------------------------
      # 7. Lint
      # ---------------------------------------------------------
      - name: üßπ Lint
        id: lint
        run: |
          START_TIME=$(date +%s)
          npm run lint 2>&1 | tee logs/lint.log
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      # ---------------------------------------------------------
      # 7.5. Auto-fix lint issues
      # ---------------------------------------------------------
      - name: üîß Auto-fix lint issues
        if: steps.lint.outcome == 'failure'
        run: |
          echo "Attempting to auto-fix lint issues..."
          npm run lint:fix 2>&1 | tee logs/lint-fix.log || true
          
          if ! git diff --quiet; then
            echo "Auto-fixes applied. Committing changes..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: auto-fix lint issues [skip ci]"
            git push
            echo "‚úÖ Lint fixes committed and pushed"
          else
            echo "‚ö†Ô∏è No auto-fixes available"
          fi

      # ---------------------------------------------------------
      # 8. Typecheck
      # ---------------------------------------------------------
      - name: üß† Typecheck
        id: typecheck
        run: |
          START_TIME=$(date +%s)
          npm run typecheck 2>&1 | tee logs/typecheck.log
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      # ---------------------------------------------------------
      # 9. Tests
      # ---------------------------------------------------------
      - name: üß™ Run tests
        id: test
        run: |
          START_TIME=$(date +%s)
          npm test 2>&1 | tee logs/test.log
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      # ---------------------------------------------------------
      # 10. Build
      # ---------------------------------------------------------
      - name: üèóÔ∏è Build
        id: build
        run: |
          START_TIME=$(date +%s)
          npm run build 2>&1 | tee logs/build.log
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true

      # ---------------------------------------------------------
      # 10.5. Upload test logs
      # ---------------------------------------------------------
      - name: üì¶ Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: logs/
          retention-days: 7

      # ---------------------------------------------------------
      # 10.6. Check for failures
      # ---------------------------------------------------------
      - name: ‚ùå Check for failures
        if: |
          steps.lint.outcome == 'failure' ||
          steps.typecheck.outcome == 'failure' ||
          steps.test.outcome == 'failure' ||
          steps.build.outcome == 'failure'
        run: |
          echo "One or more steps failed:"
          echo "  Lint: ${{ steps.lint.outcome }}"
          echo "  Typecheck: ${{ steps.typecheck.outcome }}"
          echo "  Tests: ${{ steps.test.outcome }}"
          echo "  Build: ${{ steps.build.outcome }}"
          exit 1

      # ---------------------------------------------------------
      # 11. Upload build artifacts (operator observability)
      # ---------------------------------------------------------
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist
            site/dist
          if-no-files-found: ignore

      # ---------------------------------------------------------
      # 12. Slack Notification
      # ---------------------------------------------------------
      - name: üîî Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚öôÔ∏è *CyberAi Operator CI* on `${{ github.ref_name }}`:\n*Status:* ${{ job.status }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ---------------------------------------------------------
      # 13. Discord Notification
      # ---------------------------------------------------------
      - name: üîî Notify Discord
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"‚öôÔ∏è *CyberAi Operator CI* on \`${{ github.ref_name }}\` ‚Äî *${{ job.status }}*\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ---------------------------------------------------------
  # Professional Comment System
  # ---------------------------------------------------------
  comment-test-results:
    name: üìä Post Test Results Comment
    runs-on: ubuntu-latest
    needs: build
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì• Download test logs
        uses: actions/download-artifact@v4.1.3
        with:
          name: test-logs
          path: logs/
        continue-on-error: true

      - name: üìä Generate and Post Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            
            // Helper function to read log file with truncation
            function readLog(logPath, maxLines = 500) {
              try {
                const content = fs.readFileSync(logPath, 'utf8');
                const lines = content.split('\n');
                if (lines.length > maxLines) {
                  const truncated = lines.slice(0, maxLines).join('\n');
                  return truncated + `\n\n... (truncated ${lines.length - maxLines} lines, view full logs in artifacts)`;
                }
                return content;
              } catch (error) {
                return `Log file not found or could not be read: ${error.message}`;
              }
            }

            // Helper function to format duration
            function formatDuration(duration) {
              if (!duration) return '-';
              return duration;
            }

            // Get results from build job
            const lintResult = '${{ needs.build.outputs.lint-result }}';
            const typecheckResult = '${{ needs.build.outputs.typecheck-result }}';
            const testResult = '${{ needs.build.outputs.test-result }}';
            const buildResult = '${{ needs.build.outputs.build-result }}';
            
            const lintDuration = formatDuration('${{ needs.build.outputs.lint-duration }}');
            const typecheckDuration = formatDuration('${{ needs.build.outputs.typecheck-duration }}');
            const testDuration = formatDuration('${{ needs.build.outputs.test-duration }}');
            const buildDuration = formatDuration('${{ needs.build.outputs.build-duration }}');

            // Determine overall status
            const allPassed = lintResult === 'success' && 
                            typecheckResult === 'success' && 
                            testResult === 'success' && 
                            buildResult === 'success';
            
            const overallStatus = allPassed ? '‚úÖ PASSED' : '‚ùå FAILED';

            // Helper to get status emoji
            function getStatusEmoji(result) {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              if (result === 'skipped') return '‚è≠Ô∏è';
              return '‚ö†Ô∏è';
            }

            // Helper to get status text
            function getStatusText(result) {
              if (result === 'success') return 'Passed';
              if (result === 'failure') return 'Failed';
              if (result === 'skipped') return 'Skipped';
              return 'Unknown';
            }

            // Build the comment
            const headSha = context.payload.pull_request?.head?.sha || context.sha;
            const headAuthor = context.payload.pull_request?.head?.user?.login || context.payload.pull_request.user.login;
            let comment = `## üöÄ CyberAI Pipeline Report\n\n`;
            comment += `### üìä Executive Summary\n`;
            comment += `- **Status:** ${overallStatus}\n`;
            comment += `- **Commit:** [\`${headSha.substring(0, 7)}\`](${context.payload.pull_request.head.repo.html_url}/commit/${headSha}) by @${headAuthor}\n`;
            comment += `- **Branch:** \`${context.payload.pull_request.head.ref}\`\n`;
            comment += `- **PR:** #${context.payload.pull_request.number}\n\n`;

            comment += `### üß™ Test Results\n\n`;
            comment += `| Stage | Status | Duration | Details |\n`;
            comment += `|-------|--------|----------|---------|\n`;
            comment += `| Lint | ${getStatusEmoji(lintResult)} | ${lintDuration} | ${getStatusText(lintResult)} |\n`;
            comment += `| Typecheck | ${getStatusEmoji(typecheckResult)} | ${typecheckDuration} | ${getStatusText(typecheckResult)} |\n`;
            comment += `| Tests | ${getStatusEmoji(testResult)} | ${testDuration} | ${getStatusText(testResult)} |\n`;
            comment += `| Build | ${getStatusEmoji(buildResult)} | ${buildDuration} | ${getStatusText(buildResult)} |\n\n`;

            // Add failed test details
            const failedSteps = [];
            if (lintResult === 'failure') failedSteps.push({ name: 'Lint', log: 'logs/lint.log' });
            if (typecheckResult === 'failure') failedSteps.push({ name: 'Typecheck', log: 'logs/typecheck.log' });
            if (testResult === 'failure') failedSteps.push({ name: 'Tests', log: 'logs/test.log' });
            if (buildResult === 'failure') failedSteps.push({ name: 'Build', log: 'logs/build.log' });

            if (failedSteps.length > 0) {
              comment += `<details>\n<summary>‚ùå Failed Step Details (${failedSteps.length})</summary>\n\n`;
              
              for (const step of failedSteps) {
                comment += `#### ${step.name}\n\n`;
                comment += `\`\`\`\n`;
                comment += readLog(step.log, 100);
                comment += `\n\`\`\`\n\n`;
              }
              
              comment += `</details>\n\n`;
            }

            // Add full logs in collapsible sections
            comment += `<details>\n<summary>üìã Full Logs</summary>\n\n`;
            
            const allLogs = [
              { name: 'Lint', file: 'logs/lint.log' },
              { name: 'Typecheck', file: 'logs/typecheck.log' },
              { name: 'Tests', file: 'logs/test.log' },
              { name: 'Build', file: 'logs/build.log' }
            ];

            for (const log of allLogs) {
              comment += `<details>\n<summary>${log.name} Output</summary>\n\n`;
              comment += `\`\`\`\n`;
              comment += readLog(log.file, 200);
              comment += `\n\`\`\`\n\n`;
              comment += `</details>\n\n`;
            }
            
            comment += `</details>\n\n`;

            // Auto-repair status
            comment += `### üîß Auto-Repair Status\n`;
            if (lintResult === 'failure') {
              comment += `- ‚úÖ Ran lint auto-fix (check latest commits)\n`;
            }
            if (typecheckResult === 'failure') {
              comment += `- ‚ö†Ô∏è Type errors require manual review\n`;
            }
            if (!allPassed) {
              comment += `\n### üéØ Next Steps\n`;
              comment += `- [ ] Review failed steps above\n`;
              comment += `- [ ] Check error logs\n`;
              comment += `- [ ] Run tests locally to reproduce\n`;
              comment += `- [ ] Fix issues and push changes\n\n`;
            } else {
              comment += `\n### ‚ú® All Checks Passed!\n`;
              comment += `Great work! Your changes are ready for review.\n\n`;
            }

            comment += `---\n`;
            comment += `> ÔøΩÔøΩ **Powered by CyberAI Neo CI Bot**\n`;
            comment += `> [View Full Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üöÄ CyberAI Pipeline Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

            // Add reaction to PR based on status
            if (allPassed) {
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                content: 'rocket'
              });
            }
