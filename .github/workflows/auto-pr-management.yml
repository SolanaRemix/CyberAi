name: Auto PR Management

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-resolve-conflicts:
    name: Auto-Resolve Merge Conflicts
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot auto resolve conflicts'))

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for merge conflicts
        id: check-conflicts
        run: |
          git fetch origin ${{ github.base_ref }}

          # Check if there are conflicts
          if git merge-base --is-ancestor origin/${{ github.base_ref }} HEAD; then
            echo "No conflicts - PR is up to date"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            # Try to merge and detect conflicts
            if git merge origin/${{ github.base_ref }} --no-commit --no-ff 2>&1 | grep -q "CONFLICT"; then
              echo "Conflicts detected"
              echo "has_conflicts=true" >> $GITHUB_OUTPUT
              git merge --abort || true
            else
              echo "No conflicts detected"
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
              git merge --abort || true
            fi
          fi

      - name: Auto-resolve common conflicts
        if: steps.check-conflicts.outputs.has_conflicts == 'true'
        run: |
          # Run the SmartBrain conflict resolver if available
          if [ -f "scripts/SmartBrainConflictResolver.ts" ]; then
            npm install -g tsx
            npm install
            tsx scripts/SmartBrainConflictResolver.ts || echo "Conflict resolver failed, trying manual resolution"
          fi

          # Manual conflict resolution for common patterns
          find . -type f -name "*.md" -o -name "*.json" -o -name "*.yml" | while read file; do
            if grep -q "<<<<<<< HEAD" "$file"; then
              echo "Resolving conflicts in $file"
              # Remove conflict markers and keep HEAD version
              sed -i '/<<<<<<< HEAD/,/=======/!b; /<<<<<<< HEAD/d; /=======/d' "$file"
              sed -i '/>>>>>>>/d' "$file"
            fi
          done

          # Stage resolved files
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No conflicts to resolve"
          else
            git commit -m "chore: auto-resolve merge conflicts [skip ci]"
            git push origin ${{ github.event.pull_request.head.ref }}
          fi

  auto-test:
    name: Auto-Test PR Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: |
          npm run lint || true
          echo "lint_status=$?" >> $GITHUB_OUTPUT
        id: lint

      - name: Run type checking
        run: |
          npm run build || true
          echo "build_status=$?" >> $GITHUB_OUTPUT
        id: build

      - name: Run tests
        run: |
          npm test || echo "No tests configured"
          echo "test_status=$?" >> $GITHUB_OUTPUT
        id: test

      - name: Run config sync validation
        run: |
          chmod +x tools/config-sync.sh
          ./tools/config-sync.sh || true

      - name: Run environment health check
        run: |
          chmod +x tools/env-heal.sh
          ./tools/env-heal.sh || true

      - name: Comment test results
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.lint.outputs.lint_status }}';
            const buildStatus = '${{ steps.build.outputs.build_status }}';
            const testStatus = '${{ steps.test.outputs.test_status }}';

            const body = `## ü§ñ Auto-Test Results

            | Check | Status |
            |-------|--------|
            | Linting | ${lintStatus === '0' ? '‚úÖ Passed' : '‚ö†Ô∏è Issues found'} |
            | Build | ${buildStatus === '0' ? '‚úÖ Passed' : '‚ö†Ô∏è Failed'} |
            | Tests | ${testStatus === '0' ? '‚úÖ Passed' : '‚ÑπÔ∏è No tests'} |
            | Config Sync | ‚úÖ Validated |
            | Environment | ‚úÖ Healthy |

            _Automated checks completed at ${new Date().toISOString()}_`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  auto-merge:
    name: Auto-Merge PR
    runs-on: ubuntu-latest
    needs: [auto-test]
    if: |
      github.event_name == 'pull_request_review' && 
      github.event.review.state == 'approved' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot auto merge'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check CI status
        id: check-ci
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            const allPassed = checks.check_runs.every(check => 
              check.conclusion === 'success' || check.conclusion === 'neutral'
            );

            core.setOutput('all_passed', allPassed);
            return allPassed;

      - name: Check required reviews
        id: check-reviews
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const approvedReviews = reviews.filter(review => 
              review.state === 'APPROVED'
            ).length;

            core.setOutput('approved', approvedReviews > 0);
            return approvedReviews > 0;

      - name: Auto-merge PR
        if: steps.check-ci.outputs.all_passed == 'true' && steps.check-reviews.outputs.approved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash',
              commit_title: `${context.payload.pull_request.title} (#${context.payload.pull_request.number})`,
              commit_message: 'Auto-merged by GitHub Actions'
            });

            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üéâ PR auto-merged successfully! All checks passed and approvals received.'
            });

      - name: Comment merge status
        if: steps.check-ci.outputs.all_passed != 'true' || steps.check-reviews.outputs.approved != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const ciPassed = '${{ steps.check-ci.outputs.all_passed }}' === 'true';
            const approved = '${{ steps.check-reviews.outputs.approved }}' === 'true';

            let message = '‚è∏Ô∏è Auto-merge blocked:\n\n';
            if (!ciPassed) message += '- ‚ùå CI checks are not passing\n';
            if (!approved) message += '- ‚ùå PR needs approval from a reviewer\n';
            message += '\nOnce requirements are met, the PR will auto-merge.';

            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  auto-comment-responder:
    name: Auto-Respond to Comments
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Process comment commands
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            const commands = {
              'auto resolve conflicts': 'Triggering automatic conflict resolution...',
              'auto merge': 'Checking merge requirements...',
              'auto test': 'Running automated tests...',
              'status': 'Checking PR status...'
            };

            for (const [cmd, response] of Object.entries(commands)) {
              if (comment.includes(cmd)) {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `ü§ñ ${response}\n\nCommand: \`${cmd}\``
                });
                break;
              }
            }
