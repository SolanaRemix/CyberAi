name: Advanced Build Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - development

concurrency:
  group: advanced-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Multi-platform build matrix
  build-matrix:
    name: Build (${{ matrix.os }}, Node ${{ matrix.node }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18, 20, 21]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Type check
        run: npm run typecheck

      - name: ðŸ§¹ Lint
        run: npm run lint

      - name: ðŸ”¨ Build
        run: npm run build

      - name: ðŸ§ª Test
        run: npm test

      - name: ðŸ“Š Upload build artifacts
        if: matrix.os == 'ubuntu-latest' && matrix.node == '20'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-node${{ matrix.node }}
          path: |
            dist/
            logs/
          retention-days: 7

  # Advanced optimized build
  optimized-build:
    name: Optimized Production Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸš€ Run advanced build
        run: |
          chmod +x scripts/advanced-build.sh
          ./scripts/advanced-build.sh production
        env:
          NODE_ENV: production
          VERBOSE: true

      - name: ðŸ“Š Build size analysis
        run: |
          echo "## Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Distribution Size" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find dist -type f -exec du -h {} + | sort -rh | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Upload optimized build
        uses: actions/upload-artifact@v4
        with:
          name: optimized-production-build
          path: |
            dist/
            dist/build-info.json
          retention-days: 30

  # Docker build test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: cyberai:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

      - name: ðŸ§ª Test Docker image
        run: |
          docker run --rm cyberai:test node --version

  # Build verification
  verify-build:
    name: Verify Build Outputs
    needs: [build-matrix, optimized-build]
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: optimized-production-build
          path: ./artifacts

      - name: ðŸ” Verify build outputs
        run: |
          echo "Verifying build outputs..."
          ls -lah ./artifacts/
          
          if [ ! -f "./artifacts/build-info.json" ]; then
            echo "âŒ Build info file missing"
            exit 1
          fi
          
          echo "âœ… Build verification passed"
          
          echo "## Build Info" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat ./artifacts/build-info.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Performance benchmarks
  benchmark:
    name: Performance Benchmarks
    needs: optimized-build
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“¥ Download build
        uses: actions/download-artifact@v4.1.3
        with:
          name: optimized-production-build
          path: ./dist

      - name: âš¡ Run benchmarks
        run: |
          echo "## Performance Benchmarks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build time from build-info
          if [ -f "dist/build-info.json" ]; then
            echo "### Build Information" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat dist/build-info.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # File sizes
          echo "### Output Sizes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find dist -type f -name "*.js" -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
